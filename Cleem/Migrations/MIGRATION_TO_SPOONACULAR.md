# Миграция на новую систему распознавания еды

## Общая информация

В этой версии приложения была добавлена новая система распознавания еды, которая работает по следующей схеме:

1. **Gemini Pro Vision** для определения блюда на фотографии
2. **GPT-4** для декомпозиции сложных блюд на отдельные ингредиенты
3. **Edamam API** для получения детальной информации о питательной ценности ингредиентов
4. Суммирование данных для отображения общей питательной ценности блюда

Новая система позволяет значительно улучшить точность распознавания и анализа еды, а также дает более детальную информацию по составу сложных блюд.

## Основные изменения

1. Добавлены новые сервисы:
   - `SpoonacularService` для работы с API Spoonacular
   - `OpenAIService` для работы с GPT-4

2. Создан новый менеджер распознавания `FoodRecognitionManagerV2`, который реализует новую стратегию распознавания

3. Создана новая версия камеры сканирования `ScanCameraViewV2`

4. Добавлена возможность выбора между старой и новой системой в настройках приложения

5. Добавлены новые модели данных:
   - `RecognizedFoodV2` для представления распознанной еды
   - `NutritionDataV2` для хранения данных о питательной ценности

## Обновления системы

1. Добавлена поддержка Gemini Pro Vision для улучшенного визуального распознавания
   - Новая модель более адаптирована для распознавания еды

2. Реализован процесс декомпозиции блюд с помощью GPT-4
   - Позволяет разбивать сложные блюда на отдельные ингредиенты
   - Повышает точность анализа питательной ценности

3. [ОБНОВЛЕНО] Интеграция с Edamam API для получения данных о нутриентах
   - Edamam заменяет ранее использовавшийся Spoonacular API из-за проблем с оплатой и стабильностью
   - Используется та же интеграция с Edamam, что и в основной системе
   - Предоставляет детальные данные о питательной ценности каждого ингредиента

4. Новый визуальный интерфейс для отображения данных о питательной ценности
   - Интуитивно понятные графики и диаграммы
   - Отображение состава ингредиентов для сложных блюд

5. Добавлены новые модели данных:
   - `RecognizedFoodV2` для представления распознанной еды
   - `NutritionDataV2` для хранения данных о питательной ценности

## Преимущества новой системы

1. **Улучшенное распознавание**: благодаря использованию Gemini Pro Vision, который хорошо справляется с визуальным распознаванием блюд

2. **Декомпозиция на ингредиенты**: GPT-4 позволяет разбить сложные блюда на отдельные ингредиенты, что повышает точность анализа

3. **Более точные данные о нутриентах**: Edamam API предоставляет полную информацию о питательной ценности продуктов

4. **Обработка сложных блюд**: система теперь может анализировать и отображать составные блюда с детализацией по ингредиентам

## Настройка API ключей

Для работы новой системы необходимо настроить следующие API ключи:

1. **Gemini API Key**: для визуального распознавания
   - Получение: https://makersuite.google.com/app/apikey

2. **Edamam API Key и App ID**: для данных о питательной ценности
   - Получение: https://developer.edamam.com/edamam-nutrition-api

3. **OpenAI API Key**: для декомпозиции блюд на ингредиенты
   - Получение: https://platform.openai.com/api-keys

Ключи можно настроить в разделе "Настройки" → "API Ключи (Новая система)"

## Переключение между системами

В приложении реализована возможность переключения между старой и новой системами распознавания. Это можно сделать через раздел "Настройки", выбрав предпочтительный метод распознавания:

- **Классический (Gemini + Edamam)**: старый подход
- **Новый (Gemini + GPT + Spoonacular)**: новый подход

## Технические детали реализации

Новая система использует следующий пайплайн:

1. **Распознавание блюда**: 
   ```swift
   detectDishWithGemini(image: UIImage) -> AnyPublisher<String, FoodRecognitionError>
   ```

2. **Декомпозиция на ингредиенты**:
   ```swift
   decomposeWithGPT4(dishName: String) -> AnyPublisher<[String], FoodRecognitionError>
   ```

3. **Получение данных о нутриентах**:
   ```swift
   getNutritionDataForIngredients(dishName: String, ingredients: [String], image: UIImage?)
     -> AnyPublisher<[RecognizedFoodV2], FoodRecognitionError>
   ```

4. **Суммирование данных и сохранение в CoreData**:
   ```swift
   saveFoodToCoreData(food: RecognizedFoodV2, image: UIImage?)
   ```

## Изменения в CoreData

Для поддержки новой системы в CoreData модель `Food` была добавлена следующая новая переменная:
- `isComposed: Bool` - флаг, указывающий является ли блюдо комбинированным (состоящим из нескольких ингредиентов)

## Миграция базы данных

При обновлении приложения необходимо выполнить следующие шаги для обеспечения совместимости существующих данных с новой системой:

1. **Резервное копирование данных** - перед обновлением рекомендуется экспортировать существующие данные

2. **Миграция схемы CoreData**:
   - Добавлено новое свойство `isComposed` к сущности `Food`
   - По умолчанию для существующих записей это свойство будет установлено в `false`

3. **Проверка целостности данных** - после обновления убедитесь, что существующие данные корректно отображаются

## Будущие улучшения

1. Добавление распознавания штрих-кодов с использованием Spoonacular API
2. Улучшение визуального представления ингредиентов и состава блюд
3. Интеграция с базой данных рецептов Spoonacular для предложения похожих блюд 